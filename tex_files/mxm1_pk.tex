\section
[$M^X/M/1$ Queue: Expected Waiting Time]
{$\mathbf{M^X/M/1}$ Queue: Expected Waiting Time}
\label{sec:mxm1-queue:-expected}

\subsection*{Theory and Exercises}

\Opensolutionfile{hint}
\Opensolutionfile{ans}

It is not always the case that jobs arrive in single units, they can
also arrive as batches. For instance, when a car and or bus arrives at a fast
food restaurant, a batch consists of the number of people in the vehicle.  In this section we derive for such queueing processes, denoted by the shorthand $M^X/M/1$, expressions for the load and the expected waiting time and queue length. 


Assume that jobs arrive as a Poisson process with rate $\lambda$ and
each \emph{job} contains multiple \emph{items}.  Let $A_k$ be the
arrival time of job $k$ and $A(t)$ the number of job arrivals up to
time $t$. Denote by $B_k$ the batch size, i.e., the number of items that job $k$ brings into
the system.  We assume that $\{B_k\}$ is a sequence of
i.i.d. discrete random variables distributed as a generic random variable $B$
such that $\P{B = k} = f(k)$, where $f(k)$ is a given set of
probabilities.  We write
\begin{equation*}
  G(k) = \P{B>k} = \sum_{m=k+1}^\infty f(m),
\end{equation*}
for the \emph{survivor function} of $B$.  We also assume that the
service time of each item is exponentially distributed with average
$1/\mu$. Thus, the average time to serve the entire batch is
\begin{equation*}
\E{B}\E{S}=\E B/\mu.
\end{equation*}



The first criterion we must check for the $M^X/M/1$ queue is the
stability: the service rate must be larger than the arrival rate of
work. To determine the latter, observe that the total number of items $N(t)$
arrived up to time $t$ must be equal to the number of arrivals $A(t)$
up to time $t$ times the batch size of each arrival, i.e.,
\begin{equation*}
N(t)=  \sum_{k=1}^\infty B_k \1{A_k \leq t} = \sum_{k=1}^{A(t)} B_k.
\end{equation*}
The (stochastic) process $\{N(t)\}$ is known as the \recall{compound
  Poisson process}. Clearly, the rate at which items arrive is
approximately
\begin{equation*}
  \frac{N(t)}t = \frac{A(t)}t \frac1{A(t)}\sum_{i=k}^{A(t)} B_k.
\end{equation*}
As in  the limit $A(t)/t \to \lambda$ and $(A(t))^{-1}\sum_{k=1}^{A(t)} B_k \to \E{B}$, we see that
\begin{align*}
\frac{N(t)}t \to \lambda \E B.
\end{align*}

\begin{exercise}
Conclude that   the \recall{load} must satisfy
$\rho = \lambda \E B/\mu < 1$.
\begin{solution}
For stability, it is necessary that the service rate
$\mu=1/\E S$ for items is larger than the rate at which items
arrive.  Hence,
\begin{equation*}
\rho = \lambda \E B \E S = \frac{\lambda \E B} \mu < 1.
\end{equation*}
\end{solution}
\end{exercise}

Let us next find expressions for the waiting time and queue lengths. For this, we need to describe the queueing process is somewhat more detail. A batch joins the end of the queue (if present), and once the queue in front of it is cleared, the entire batch moves from the queue to the server. Then the server starts serving the batch. As the service of the first item of the batch starts right away, this item does not have to wait. The last item, however, must wait for all the other items of the batch to be served before its service can start. Consequently, all items of a batch, except the first, also have to wait at the server before service starts. 


For the average waiting time, we use the derivation of $\E{W_Q}=\E{S_r}/(1-\rho)$, i.e., \eqref{eq:35}, as guidance. Suppose a batch finds $\E{L}$ items in the system upon
arrival. By the memoryless property of the service distribution, the
expected remaining service time of the item in service (if any) is
$\E S$. Therefore the expected time the entire batch
spends in queue is
\begin{equation*}
  \E{W_{Q,b}} = \E{L} \E S;
\end{equation*}
compare Eq.~\ref{eq:wqes}. 
%Note that this is not the same as $\E{W_Q}$, which is the expected time an \emph{item} spends in queue.
Next, if $B_r$ is the number of items of the batch currently at the server
($B_r=0$ if the server is idle), and $L_{Q,b}$ the number of batches
in queue, then
\begin{equation*}
  \E{L} = \E{L_{Q,b}}\E B + \E{B_r}.
\end{equation*}
\begin{exercise}
  Combine the above with  Little's law to show that
  \begin{equation*}
  \E{W_{Q,b}} = \frac{\E{B_r}}{1-\rho}\E{S}.
  \end{equation*}
\begin{solution}
\begin{equation*}
  \E{W_{Q,b}} 
= \E{L} \E S  = (\E{L_{Q,b}}\E B + \E{B_r})\E S.
\end{equation*}
With  Little's law, $\E{L_{Q,b}} = \lambda \E{W_{Q,b}}$,
\begin{equation*}
  \E{W_{Q,b}} 
= \lambda \E S \E B \E{W_{Q,b}} + \E S \E{B_r} = \rho \E{W_{Q,b}} + \E S \E{B_r},
\end{equation*}
hence,
\begin{equation*}
  \E{W_{Q,b}} = \frac{\E{B_r}}{1-\rho}\E S.
\end{equation*}
\end{solution}
\end{exercise}
Below we prove that  the expected number of items at the server is given by
\begin{equation}\label{eq:br}
  \E{B_r} = \frac 1 2 \frac{\E{B^2}}{\E B}\rho + \frac\rho2.
\end{equation}


\begin{exercise}\label{q:batch}
To simplify this expression for $\E{B_r}$, show that 
\begin{equation*}
  \frac{\E{B^2}}{\E{B}} = (1+C_s^2)\E B, \quad\text{where }
C_s^2 = \frac{\V B}{(\E B)^2},
\end{equation*}
is the square coefficient of variation of the batch sizes.  
  \begin{solution}
We have
\begin{equation*}
  \begin{split}
  \frac{\E{B^2}}{\E{B}}
=    \frac{\E{B^2}}{(\E B)^2} \E B 
= \frac{(\E B)^2+\V B}{(\E B)^2}\E B = (1+C_s^2)\E B.
  \end{split}
\end{equation*}
  \end{solution}
\end{exercise}

With the results of the above exercises we can establish two cornerstones of queueing theory. The first is the expected waiting time, 
\begin{equation}
\E{W_{Q,b}} = \frac{\E{B_r}}{1-\rho} \E{S} = 
\frac{1+C_s^2}2 \frac{\rho}{1-\rho} \E B \E S + \frac12\frac\rho{1-\rho}\E S.
\end{equation}
Second, for the number of items in the system we find
\begin{equation}\label{eq:43}
\E{L}  =\frac{\E{W_{Q,b}}}{\E S} =  
\frac{1+C_s^2}2 \frac{\rho}{1-\rho} \E B + \frac12\frac\rho{1-\rho}.
\end{equation}
Thus, to compute the average number of items in the system, we only
need to know the first and second moment (or the variance) of the
batch size $B$. Thus, no matter how `complicated' the distribution of
$B$, when its second moment exists, the average queue length and
waiting time can be computed with the above result. 

\begin{exercise}
  Show that  when the batch size is 1, the expression $\E{L(M^X/M/1)}$, i.e., the system length for the $M^X/M/1$ queue, reduces to
  $\E{L(M/M/1)}$, i.e., the system length for the $M/M/1$ queue. 
(Realize the importance of such checks.)
  \begin{hint}
What is the    distribution of the batch size $B$ for the $M/M/1$ queue?
  \end{hint}
  \begin{solution}
    For the $M/M/1$ queue, each job contains just one item. Thus,
    $B\equiv 1$, hence $\P{B=1}=1$, $\E{B^2}=\E B =1$. Therefore,
    $\E{B_r(M/M/1)}= \rho$, and $\E{L(M/M/1)}=\rho/(1-\rho)$. 
  \end{solution}
\end{exercise}


\begin{exercise}
  What is $\E L$ in case $B_k=3$ always, and $\lambda=1$, $\mu=6$?  
  \begin{hint}
Use Eq.~\ref{eq:43}. What are $\E{B^2}$, $\E B$ and $\V B$ for this case?
  \end{hint}
\begin{solution}
  As $B$ is constant and equal to 3, $\E{B^2}=9$, hence $\V B=0$,
  hence $C_s^2=0$.  Also, $\rho=\lambda\E B/\mu=1\cdot 3/6=1/2$. Hence
  \begin{equation*}
    \E L = \frac 1 2 \frac{1/2}{1-1/2}\cdot 3 + \frac12\frac{1/2}{1-1/2}.
  \end{equation*}
  \end{solution}
\end{exercise}

\begin{exercise}
  If the batch size is $p$ geometrically distributed, what is $\E L$?
  \begin{hint}
$f_k=q^{k-1}p$ with $q=1-p$. Use generating functions to compute $\E B$ and $\E{B^2}$
  \end{hint}
\begin{solution}
  We need $\V B$ and $\E B$. Consider
  \begin{equation*}
    \begin{split}
    \phi(z) 
&= \E{z^B} = \sum_{k=0}^\infty z^k \P{B=k} = \sum_{k=0}^\infty z^k f_k \\
&= \sum_{k=0}^\infty z^k p q^{k-1} 
= \frac p q \sum_{k=0}^\infty (q z)^k = \frac p q \frac1{1-q z}.
    \end{split}
  \end{equation*}

Then
\begin{equation*}
  \E B = \phi'(1) = \left.\frac p q \frac q{(1-q z)^2}\right|_{z=1}= \frac p{(1-q)^2} = \frac 1 p,
\end{equation*}
and
\begin{equation*}
  \E{B(B-1)} = \phi''(1) = \left.\frac p q \frac{2q^2}{(1-q z)^3}\right|_{z=1}= 2 \frac{q}{p^2}= \frac2{p^2} - \frac 2p.
\end{equation*}
Hence, 
\begin{equation*}
  \E{B^2} = \frac2{p^2} - \frac 2p + \E B = \frac2{p^2} - \frac1p,
\end{equation*}
and
\begin{equation*}
  \V B = \E{B^2} - (\E B)^2 = \frac2{p^2} - \frac1p - \frac1{p^2} = \frac1{p^2}-\frac1p,
\end{equation*}
and
\begin{equation*}
  C_s^2= \frac{\V B}{(\E B)^2} = p^2 \left(\frac1{p^2}-\frac1p\right)=1-p
\end{equation*}
Then,
\begin{equation*}
  (1+C_s^2)/2= 1-p/2.
\end{equation*}
and 
\begin{equation*}
  \E L = 
\left(1-\frac p2\right) \frac\rho{1-\rho} \frac 1 p + \frac12\frac\rho{1-\rho}
=\frac\rho{1-\rho} \frac 1 p.
\end{equation*}

Can we check this in a simple way? If $\P{B=1}=f_1 = p =1$, then
$\E L=\rho/(1-\rho)$. Thus, we get the result for the $M/M/1$
queue. The result is at least consistent with earlier work.
\end{solution}
\end{exercise}

\begin{exercise}
  A common operational problem is a machine that receives batches of
  various sizes. Management likes to know how a reduction of the
  variability of the batch sizes would affect the average queueing time.
  Suppose, for the sake of an example, that the batch size 
  \begin{equation*}
    \P{B=1} = \P{B=2} = \P{B=3} = \frac 13.
  \end{equation*}
  Batches arrive at rate 1 per hour. The average processing for an
  item is $25$ minutes.  By how much would the waiting time decrease if
  batch sizes are constant and equal to~$2$ (observe that in both cases $\E B =2$).
  \begin{solution}
    Start with the simple case, $B\equiv 2$. Then $\V{B}=0$ and
    $\E B = 2$. The load is $\rho=\lambda \E B \E S = 1\cdot 2 \cdot 25/60 = 5/6$.  hence,
    \begin{equation*}
      \E{L} = \frac 12 \frac{5/6}{1/6} 2 + \frac 12 \frac{5/6}{1/6} = 5 + \frac52.
    \end{equation*}

Now the other case. $\E{B^2} = (1+4+9)/3 = 14/3$. Hence, $\V B=14/3 - 4=2/3$. Hence, 
\begin{equation*}
C_s^2=\frac{\V B}{(\E B)^2} = \frac{2/3}4 = \frac 16.
\end{equation*}
And thus, 
    \begin{equation*}
      \E{L} = \frac {1+1/6}2 \frac{5/6}{1/6} 2 + \frac 12 \frac{5/6}{1/6} = \frac76 5 + \frac 52.
    \end{equation*}
    If we divide these two answers, we see that the ratio between
    $\E{L}$ for both answers is $10/9$. In other words, we can
    reduce about 10\% of the number of items in the system by working
    in fixed batch sizes. 
  \end{solution}
\end{exercise}

Observe how easy it is with these models to get insight into the order
of magnitude of queue length reductions or waiting times that can be
achieved with changing work habits, such making batch sizes constant
rather than allowing them to vary. Observe also that it is up to
management to decide whether such reductions outweigh any efforts to
reduce the variation in batch sizes. 


\begin{exercise}
  Show that $\E{L(M^X/M/1)} \geq \E{L(M/M/1)}$ when the loads are the
    same. What do you conclude?
  \begin{solution}
    \begin{equation*}
    \frac{\E{L(M^X/M/1)}}{\E{L(M/M/1)}} = \frac{\E{B_r}}{\rho} = 
\frac{\E{B^2}}{2\E B} + \frac 12.
    \end{equation*}
With this we can check whether this condition
    \begin{equation*}
    1\leq \frac{\E{L(M^X/M/1)}}{\E{L(M/M/1)}} = \frac{\E{B^2}}{2\E B} + \frac 12
    \end{equation*}
    is always true. Clearly, it reduces to
\begin{equation*}
\E B \leq  \E{B^2}.
\end{equation*}
Multiply this by $\E B$ for reasons to become clear presently to get
\begin{equation*}
(\E B)^2 \leq  \E{B^2} \E B.
\end{equation*}
So, the initial inequality is converted to this, and we like to know
whether this always true.


To see this, we can use Jensen's inequality
$\phi(\E X) \leq \E{\phi(X)}$ when $\phi$ is convex. In this case take
$\phi(x)=x^2$, so that Jensen's inequality states that
$(\E B)^2 \leq \E{B^2}$. (BTW, note that Jensen's inequality implies
that $\V X = \E{X^2} - (\E X)^2\geq 0$.)  Now noting that $B\geq 1$, as a
job minimally contains one item, we get
\begin{equation*}
  \begin{split}
(\E B)^2 
&\leq  \E{B^2}, \quad{\text{by Jensen's inequality}} \\
&\leq   \E{B^2} \E B, \quad{\text{ as } B \geq 1}.
  \end{split}
\end{equation*}
Clearly, this is the inequality we tried to show. As a result,
    \begin{equation*}
    1\leq \frac{\E{L(M^X/M/1)}}{\E{L(M/M/1)}}
    \end{equation*}
for all $B$. 

In conclusion, if work arrives in batches, the average number of jobs
in the system, increases, hence the average waiting time increases.
  \end{solution}
\end{exercise}



\begin{exercise}
  In a production environment, a machine replenishes an inventory of
  items (e.g., hamburgers) at a fixed rate of $1$ per 3 minutes. If
  the inventory reaches the \emph{produce-up-to} level $S$, the machine stops.  Customers
  arrive at rate of 6 per hour. A customer can buy items in different
  quantities, $B=1,2,3,4$, all with equal probability. What is a
  sensible value for the produce-up-to level $S$?   
  \begin{hint}
Realize that the inventory process $I(t)$ behaves as     $I(t)=S-L(t)$ where $L(t)$ is a suitable queueing process. Refer to Ex.~\ref{ex:7} for further background.
  \end{hint}
  \begin{solution}
Consider a queueing system with job
arrival rate $\lambda=6$ per hour and the jobs have batch sizes as
indicated in the problem. The average number of items in the system
follows like this
    \begin{align*}
      \E B &= \frac{1+2+3+4}{4} = \frac 52 \\
      \E{B^2} &= \frac{1+4+9+16}{4} = \frac{30}4\\
      \V{B^2} &= \frac{30}4 - \frac{25}4 = \frac 5 4\\
      C_s^2 &= \frac{5/4}{25/4} = \frac 15\\
      \rho &= \lambda \E B \E S = 6 \frac 52 \frac 1{20} = \frac 34.
    \end{align*}
Hence, 
\begin{equation*}
  \E{L} = \frac {1+1/5}2 \frac{3/4}{1/4} \frac 52 + \frac 12 \frac{3/4}{1/4} = 6.
\end{equation*}

Thus, if the level is set to $S=4$, then on average there will be two
items short. Clearly, then, $S$ should be at least $6$. However,
$\E{L}$ is just the average. Roughly speaking, in this case half of
the demand will then be lost. So, if we take variability into account,
$S$ should be quite a bit bigger than 6. 

A more detailed analysis is
necessary to determine the right value of $S$ such that not more than
a certain fraction of demand is lost. We will address this issue in
Section~\ref{sec:batch-arrivals}.
  \end{solution}
\end{exercise}



We now turn to proving~\eqref{eq:br} with sample-path arguments and
counting; it is an elegant line of reasoning. Moreover, this derivation of the distribution of  the \emph{remaining lifetime   distribution} or the \emph{residual life} is useful in its own right and used in, for instance, maintenance planning. 


For this purpose, consider  the start and finish times of the batches in service.  Then, remove all idle periods of the server, so that we paste together the times during which the server is busy, and plot the remaining job size as a function of time, 
c.f., Figure~\ref{fig:remainingservicetime}.  Define $R$ as the
remaining number of items to be served of the batch in service at some
arbitrary point in time. Let us show with Figure~\ref{fig:remainingservicetime} that
\begin{equation*}
  \P{R=i} =\frac{\P{B\geq i}}{\E B} = \frac{G(i-1)}{\E B}.
\end{equation*}

In Figure~\ref{fig:remainingservicetime} concentrate on level
$i$. Only jobs whose initial batch size is larger or equal to~$i$ can
produce  $i$ items at the server.
Thus, by counting, we see in Figure~\ref{fig:remainingservicetime}
that $\sum_{k=1}^n \1{B_k \geq i}$ is the number of times there are
precisely~$i$  items at the server.  We also see that $\sum_{k=1}^n B_k$ is
the total number of items served while the server is busy. Thus, the fraction of time there
are $i$ remaining items is
\begin{equation*}
  \frac{\sum_{k=1}^n \1{B_k \geq i}}{\sum_{k=1}^n B_k}.
\end{equation*}
By PASTA this is also the fraction of jobs that see~$i$ items at the server.  Finally, 
\begin{equation*}
\P{R=i} = \lim_{n\to\infty} \frac{\sum_{k=1}^n \1{B_k \geq i}}{\sum_{k=1}^n B_k} 
= \lim_{n\to\infty}  \frac{n^{-1}\sum_{k=1}^n \1{B_k \geq i}}{n^{-1}\sum_{k=1}^n B_k} = \frac{G(i-1)}{\E B},
\end{equation*}
where  the limits exist by the strong law. With  Exercise~\ref{ex:ER} 
the expected remaining time can be simplified to
\begin{equation*}
  \E{R} 
= \sum_{i=1}^\infty i \P{R=i} = \frac1{\E B}\sum_{i=1}^\infty i G(i-1) 
= \frac{\E{B^2}}{2\E B} + \frac{1}2.
\end{equation*}
Finally, recalling that in the above we conditioned on the server
being busy, we get that $\E{B_r} = \rho \E R$, thereby yielding~\eqref{eq:br}.

\begin{figure}[th]
  \centering
  \begin{tikzpicture}[yscale=0.8,xscale=0.6,
  open/.style={shape=circle, fill=white, inner sep=1pt, draw, node contents=},
  closed/.style={shape=circle, fill=black, inner sep=1pt, draw, node contents=}]

    % y = zero line
    \draw (-0.5, 0) -- (18.5, 0); 
    % level crossing
    \draw (-0.5, 2.5) -- (18.5, 2.5) 
    node[pos=0.65, fill=white, above]  {$\sum_{k=1}^n \1{B_k \geq i}$}
    node[pos=0.92, fill=white]  {$y=i$};


    \draw node (c1) at (0,3.5) [closed, label={}]
          node (c2) at (3.5,0)[open, label={}]
     (c1) to (c2);
    \draw[dotted] (0,0) -- (0,3.5) node[midway, fill=white] {$B_1$};
    \draw[dotted, <->] (1, 0.05) -- (1, 2.45) node[fill=white, midway, rotate=90] {$i$};


    \draw node (c1) at (3.5,1.5) [closed, label={}]
          node (c2) at (5,0)[open, label={}]
     (c1) to (c2);
    \draw[dotted] (3.5,0.1) -- (3.5,1.5) node[midway, fill=white] {$B_2$};

    \draw node (c1) at (5,4) [closed, label={}]
          node (c2) at (9,0)[open, label={}]
     (c1) to (c2);
    \draw[dotted] (5,0.1) -- (5,4) node[midway, fill=white] {$B_3$};
    \draw[dotted, <->] (6.5, 0.05) -- (6.5, 2.45) node[fill=white, midway, rotate=90] {$i$};

    \draw node (c1) at (9,2.3) [closed, label={}]
          node (c2) at (11.3,0)[open, label={}]
     (c1) to (c2);
    \draw[dotted] (9,0.1) -- (9,2.3) node[midway, fill=white] {$B_4$};

    % end
    \draw node (c1) at (14.5,3.5) [closed, label={}]
          node (c2) at (18,0)[open, label={}]
     (c1) to (c2);
    \draw[dotted] (14.5,0.1) -- (14.5,3.5) node[midway, fill=white ] {$B_n$};
    \draw[dotted, <->] (15.5, 0.05) -- (15.5, 2.45) node[fill=white, midway, rotate=90] {$i$};
    

    % bottom line
    \draw[<->] (0, -0.6) -- (18, -.6) node[fill=white, midway] {$\sum_{k=1}^n B_k$};
\end{tikzpicture}

\caption{The remaining job size as a function of time. The
  total number of service periods, which is equal to the number of items arrived, is $\sum_{k=1}^n B_k$. A batch crosses   the line $y=i$ iff it contains at least $i$ items. Thus, during the service of a batch with $i$ or more items, there is precisely one  period during which the $i$-th item of a batch  is waiting in queue. Consequently, $\sum_{k=1}^n \1{B_k\geq i}$ is the number of periods in which there are precisely $i$ items waiting at the server. The fraction of  periods  there are~$i$ items is therefore
  $\sum_k^n \1{B_k\geq i}/\sum_k^n B_k$.}
  \label{fig:remainingservicetime}
\end{figure}


\begin{exercise}\label{ex:ER}
  Show that $2 \sum_{i=i}^\infty i G(i-1)= \E{B^2} + \E B.$
  \begin{hint}
    Use Exercises~\ref{ex:6} and \ref{ex:66}.
  \end{hint}
  \begin{solution}
\begin{equation*}
  \begin{split}
2 \sum_{i=1}^\infty i G(i-1) 
&=2\sum_{i=0}^\infty (i+1) G(i) 
=2\sum_{i=0}^\infty i G(i) +
2\sum_{i=0}^\infty G(i)\\
&= \E{B^2} - \E B + 2\E B.
  \end{split}
\end{equation*}
  \end{solution}
\end{exercise}


\paragraph{Alternative derivation}
Here is an alternative derivation of the fraction of jobs that see $i$ items at the server. Perhaps this is easier. If so, let me know. This is not obligatory reading, BTW. 

Let $L_s(s)$ be the number of items (of the batch in service) at the server. Then, 
\begin{equation*}
  Y_S(i, t) = \int_0^t \1{L_S(s)=i} \d s
\end{equation*}
is the total time up to time $t$ that there are $i$ items at the server. 

\begin{exercise}
Let $\tilde A_k$ be the moment the $k$th batch moves to the server and $D_k$ its departure time. Show that, when $S_{k,i}$ is the service time of the $i$th item of batch~$k$,  
\begin{equation*}
  \int_{\tilde A_k}^{D_k} \1{L_S(s)=i} \d s = S_{k,i} \1{B_k \geq i}, 
\end{equation*}
\begin{solution}
Only if $B_k \geq i$ there can be an $i$th item of the batch, and the time this $i$th item spends at the server is its service time $S_{k,i}$.   
\end{solution}
\end{exercise}


\begin{exercise}\label{ex:14}
Use the previous exercise to show that 
\begin{equation*}
  Y_S(i, D_n) = \sum_{k=1}^n \1{B_k\geq i} S_{k,i}.
\end{equation*}
\begin{hint}
  Observe that $n$ batches have been served at time $D_n$.
\end{hint}
\begin{solution}
At the departure time $D_n$ of the $n$th batch, precisely $n$ batches have been served. Thus, each batch with more than $i$ items, contributed to the integral $\int_0^{D_n} \1{L_S(s) =i} \d s$ with the service time $S_{k,i}$. 
\end{solution}
\end{exercise}


In Exercise~\ref{ex:14} we will use the result that
\begin{equation*}
\lim_{n\to\infty} \frac{\sum_{k=1}^n \1{B_k\geq i} S_{k,i}}{\sum_{k=1}^n \1{B_k\geq i}} = 
\E{S \given B\geq i} = \E{S}
 \end{equation*}
where the last equality follows from independence.  The next exercise is meant to help understand this.

\begin{exercise}
We are given two i.i.d. sequences $A_1, A_2, \ldots $ and $H_1, H_2, \ldots$, where $A_k$ is the  $k$th person's age and $H_k$ the height. Show that
\begin{equation*}
\lim_{n\to\infty} 
\frac{  \sum_{k=1}^n \1{A_k\leq 15, H_k \leq 1.8}}{\sum_{k=1}^n \1{A_k \leq 15}} 
= \P{H\leq 1.8 \given A \leq 15},
\end{equation*}
where $H$ and $A$ are the limiting r.v.s. associated with $\{H_k\}$ and $\{A_k\}$, respectively. With this, show that
\begin{equation*}
  \lim_{n\to\infty} \frac{ \sum_{k=1}^n H_k \1{A_k\leq 15}}{\sum_{k=1}^n \1{A_k \leq 15}} = \E{H \given A\leq 15}.
\end{equation*}
\begin{hint}
  Divide and multiply by $1/n$. 
\end{hint}
\begin{solution}
\begin{equation*}
  \begin{split}
\frac{  \sum_{k=1}^n \1{A_k\leq 15, H_k \leq 1.8}}{\sum_{k=1}^n \1{A_k \leq 15}} 
&= \frac{ n^{-1} \sum_{k=1}^n \1{A_k\leq 15, H_k \leq 1.8}}{n^{-1}\sum_{k=1}^n \1{A_k \leq 15}} \\
&\to \frac{\P{H\leq 1.8, A\leq 15}}{\P{A\leq 15}} = \P{H\leq 1.8 \given A\leq 15}.
  \end{split}
\end{equation*}

The next equation is more subtle. Take some $\delta>0$. It is simple to see that
\begin{equation*}
\delta \sum_{m=0}^\infty m \1{H_k \in [m\delta, (m+1)\delta)}
\leq H_k \leq \delta \sum_{m=0}^\infty (m+1) \1{H_k \in [m\delta, (m+1)\delta)}.
\end{equation*}
Moreover, if $\delta\to 0$, the left and right hand side converge. Let us use the left hand side as an approximation for $H_k$. 

\begin{align*}
\frac{ \sum_{k=1}^n H_k \1{A_k\leq 15}}{\sum_{k=1}^n \1{A_k \leq 15}} 
&\approx
\delta \frac{ \sum_{k=1}^n  \sum_{m=0}^\infty m \1{A_k\leq 15, H_k \in [m\delta, (m+1)\delta)}}{\sum_{k=1}^n \1{A_k \leq 15}}  \\
&= \delta \sum_{m=0}^\infty m \frac{ \sum_{k=1}^n   \1{A_k\leq 15, H_k \in [m\delta, (m+1)\delta)}}{\sum_{k=1}^n \1{A_k \leq 15}}  \\
&\stackrel{n\to\infty}{\longrightarrow} \delta \sum_{m=0}^\infty m \frac{ \P{{A\leq 15, H \in [m\delta, (m+1)\delta)}}}{\P{A \leq 15}}  \\
&=\delta \sum_{m=0}^\infty m \P{H \in [m\delta, (m+1)\delta)\given A \leq 15} \\
&\stackrel{\delta\to0}{\longrightarrow}  \E{H\given A \leq 15}.
\end{align*}
Finally, if $H$ and $A$ would be independent (which they are not), then it is easy  in the above to take out the condition on $A\leq 15$ and conclude that $\E{H\given A\leq 15} = \E{H}$. 
\end{solution}
\end{exercise}


\begin{exercise}
By taking the time average, show that
\begin{equation*}
\P{Y_S=i} =\lim_n  \frac{Y_S(i, D_n)}{D_n} = \rho \frac{G(i-1)}{\E B}.
\end{equation*}
\begin{hint}
  Take the middle term and divide and multiply by suitable other counting functions along the sample path, such as $\sum_{k=1}^n \1{B_k \geq i}$ and $D_n$. Also use rate stability, i.e., $\lambda=\delta$. 
\end{hint}
  \begin{solution}
By taking the time average and assuming that all limits exists, we get
\begin{equation*}
  \begin{split}
\P{Y_S=i} &=\lim_n  \frac{Y_S(i, D_n)}{D_n} \\
&= \lim_n \frac{n}{D_n} \cdot \frac{\sum_{k=1}^n \1{B_k\geq i}}n \cdot
\frac{\sum_{k=1}^n \1{B_k\geq i} S_{k,i}}{\sum_{k=1}^n \1{B_k\geq i}}.
  \end{split}
\end{equation*}
Observe now that the first fraction becomes the departure rate $\delta$, the second is the fraction of batches containing at least $i$ items, and the third converges to $\E S$ as the service times of  the items are i.i.d.  Thus, by rate stability and using that $G(i)=\P{B>i}$, 
\begin{equation*}
\P{Y_S=i} = \delta \P{B\geq i} \E S = \lambda G(i-1) \E S = \rho \frac{G(i-1)}{\E B},
\end{equation*}
where in the last step we use $\rho=\lambda \E S \E B$.
  \end{solution}
\end{exercise}

\begin{exercise}
Show that $\P{B_r=i} =\P{Y_S=i}$, i.e.,  the probability that a batch arriving at the system sees  $B_r=i$ items at the server is equal to the fraction of time that $Y_s=i$.
\begin{solution}
Follows right away from the PASTA property.
\end{solution}
\end{exercise}

With the above exercises we conclude that
\begin{equation*}
  \E{B_r} = \sum_{i=0}^\infty i \P{B_r=i} = \frac{\rho}{\E B} \sum_{i=1}^\infty i G(i-1).
\end{equation*}





\Closesolutionfile{hint}
\Closesolutionfile{ans}

\opt{solutionfiles}{
\subsection*{Hints}
\input{hint}
\subsection*{Solutions}
\input{ans}
}

%\clearpage

%%% Local Variables:
%%% mode: latex
%%% TeX-master: "../queueing_book"
%%% End:

